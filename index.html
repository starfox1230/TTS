<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TTS Two-Step Demo</title>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 800px; margin: auto; }
    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 4px;
    }
    input, textarea {
      background: #1e1e1e;
      color: #e0e0e0;
    }
    button {
      background: #1e88e5;
      color: #fff;
      cursor: pointer;
    }
    button:hover { background: #1565c0; }
    .audio-item {
      margin-top: 20px;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
    }
    #statusMessages {
      margin-top: 10px;
      font-size: 1em;
      color: #90caf9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>TTS Two-Step Generator</h1>
    <input type="text" id="title" placeholder="Enter title">
    <textarea id="text" rows="6" placeholder="Enter text here"></textarea>
    <select id="voice">
      <option value="">Select a voice (optional)</option>
      <option value="echo">Echo</option>
      <option value="ash">Ash</option>
      <option value="alloy">Alloy</option>
      <option value="fable">Fable</option>
      <option value="onyx">Onyx</option>
      <option value="nova">Nova</option>
      <option value="shimmer">Shimmer</option>
    </select>
    <button id="generateBtn">Generate Audio</button>
    
    <div id="statusMessages"></div>
    <div id="audioList"></div>
  </div>

  <script>
    const API_BASE = 'https://tts-jeh9.onrender.com'; 
    // Replace with your actual server URL if different

    const generateBtn = document.getElementById('generateBtn');
    const statusDiv = document.getElementById('statusMessages');
    const audioList = document.getElementById('audioList');

    generateBtn.addEventListener('click', async () => {
      statusDiv.innerText = '';
      audioList.innerHTML = '';

      const title = document.getElementById('title').value || 'Untitled';
      const text = document.getElementById('text').value;
      const voice = document.getElementById('voice').value;

      // Step 1: POST to /initiate-audio-generation
      // to receive a requestId for the SSE step
      try {
        const initResponse = await fetch(`${API_BASE}/initiate-audio-generation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, text, voice })
        });
        if (!initResponse.ok) {
          throw new Error(`Initiation request failed: ${initResponse.statusText}`);
        }
        const initData = await initResponse.json();
        const requestId = initData.requestId;
        if (!requestId) {
          throw new Error('No requestId returned from server.');
        }

        // Step 2: Open SSE to /generate-audio-stream?requestId=...
        const eventSource = new EventSource(`${API_BASE}/generate-audio-stream?requestId=${encodeURIComponent(requestId)}`);

        eventSource.onmessage = (e) => {
          // Parse the SSE message
          const data = JSON.parse(e.data);
          if (data.status) {
            // Update status
            statusDiv.innerText = data.status;
          } else if (data.error) {
            // Display error
            statusDiv.innerText = `Error: ${data.error}`;
            eventSource.close();
          } else if (data.audioBase64 && data.title) {
            // Final audio data
            statusDiv.innerText = 'Process complete.';
            // Convert base64 to Blob
            const binary = atob(data.audioBase64);
            const array = [];
            for (let i = 0; i < binary.length; i++) {
              array.push(binary.charCodeAt(i));
            }
            const blob = new Blob([new Uint8Array(array)], { type: 'audio/mpeg' });
            const blobUrl = URL.createObjectURL(blob);

            // Create audio item
            const item = document.createElement('div');
            item.className = 'audio-item';
            item.innerHTML = `
              <h3>${data.title}</h3>
              <audio controls src="${blobUrl}"></audio><br/>
              <a href="${blobUrl}" download="${data.title}.mp3">Download ${data.title}.mp3</a>
            `;
            audioList.prepend(item);

            // Close SSE
            eventSource.close();
          }
        };

        eventSource.onerror = (err) => {
          console.error('SSE Error:', err);
          statusDiv.innerText = 'An error occurred while receiving updates.';
          eventSource.close();
        };
      } catch (error) {
        console.error('Generation Error:', error);
        statusDiv.innerText = `Generation Error: ${error.message}`;
      }
    });
  </script>
</body>
</html>
